const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const rootDir = path.join(__dirname, '..');
const buildVersionFile = path.join(rootDir, 'BUILD_VERSION');
const outFile = path.join(rootDir, 'src', 'lib', 'build-info.ts');

function safeExec(cmd) {
  try {
    return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim();
  } catch {
    return '';
  }
}

// Read build version (if any)
let buildNumber = '0';
if (fs.existsSync(buildVersionFile)) {
  buildNumber = fs.readFileSync(buildVersionFile, 'utf8').trim() || '0';
}

const commitHash = safeExec('git --no-pager rev-parse --short HEAD');
const commitTimestamp = safeExec('git --no-pager log -1 --format=%cI'); // ISO8601

const banner = `// THIS FILE IS AUTO-GENERATED by scripts/generate-build-info.js
// Do not edit manually.

export const BUILD_NUMBER = '${buildNumber}';
export const BUILD_LABEL = 'dev-v${buildNumber}';
export const GIT_COMMIT_HASH = '${commitHash}';
export const GIT_COMMIT_TIMESTAMP = '${commitTimestamp}';
`;

fs.mkdirSync(path.dirname(outFile), { recursive: true });
fs.writeFileSync(outFile, banner);
console.log('Generated build info:', { buildNumber, commitHash, commitTimestamp });
