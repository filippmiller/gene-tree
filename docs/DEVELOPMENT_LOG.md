# Development Log - Gene Tree Project

**Проект**: Генеалогическое дерево (Genealogical Tree)  
**Дата начала лога**: 2025-11-10  
**Цель**: Детальное отслеживание всех изменений в проекте

---

## 2025-11-10

### Сессия 1: Визуализация Family Tree

#### 10:05 - Инициализация проекта визуализации дерева

**Установлены зависимости:**
- `@xyflow/react` - библиотека для интерактивных графов
- `elkjs` - алгоритм автоматической раскладки (Sugiyama layout для иерархий)
- `zustand` - state management для React

**Команда:**
```bash
npm install @xyflow/react elkjs zustand
```

**Миссия:** Подготовка инструментов для визуализации семейного дерева с поддержкой панорамирования, зума и автоматической раскладки узлов.

---

#### 10:10 - Создана SQL миграция для VIEW-адаптеров

**Файл:** `supabase/migrations/0011_tree_views.sql`

**Создано 5 VIEW:**

1. **`gt_v_person`** (строки 10-28)
   - **Миссия:** Нормализованное представление людей из таблицы `user_profiles`
   - **Что делает:** Объединяет first_name, middle_name, last_name в единое поле `name`
   - **Используется в:** API endpoint `/api/tree` для получения данных о людях

2. **`gt_v_parent_child`** (строки 36-41)
   - **Миссия:** Извлечение связей родитель→ребёнок из таблицы `relationships`
   - **Что делает:** Фильтрует только relationship_type='parent'
   - **Используется в:** Построение иерархии дерева, рекурсивные запросы

3. **`gt_v_union`** (строки 50-89)
   - **Миссия:** Создание виртуальных "союзов" (браки/партнёрства) между родителями
   - **Что делает:** 
     - Находит пары супругов (relationship_type='spouse')
     - Находит пары со-родителей (у которых есть общие дети)
     - Объединяет их в единый список союзов
   - **Формат ID:** `'U:' || person1_id || ':' || person2_id`
   - **Используется в:** Визуализация браков на дереве, группировка детей по парам родителей

4. **`gt_v_union_child`** (строки 97-128)
   - **Миссия:** Связь "союз→ребёнок" для правильной визуализации
   - **Что делает:**
     - Определяет, какие дети принадлежат каким союзам родителей
     - Обрабатывает случаи с двумя родителями и одним родителем (single parent)
   - **Используется в:** Построение рёбер от "союза" к детям в графе

5. **`gt_v_tree_stats`** (строки 134-139)
   - **Миссия:** Быстрая статистика по данным дерева
   - **Что делает:** Подсчитывает количество людей, связей, союзов
   - **Используется в:** Отладка, мониторинг данных

**Применение:** Миграция будет применена через Supabase CLI или Railway

---

#### 10:15 - Созданы TypeScript типы

**Файл:** `src/components/tree/types.ts`

**Основные типы:**

1. **`Person`** (строки 3-15)
   - **Миссия:** Описание человека в дереве
   - **Поля:** id, name, gender, birth_date, death_date, photo_url, is_alive
   - **Используется в:** Все компоненты визуализации, API responses

2. **`ParentChild`** (строки 17-20)
   - **Миссия:** Связь родитель→ребёнок
   - **Используется в:** Построение иерархии, рекурсивные запросы

3. **`Union`** (строки 22-28)
   - **Миссия:** Виртуальный узел "союз" (брак/партнёрство)
   - **Поля:** union_id, p1, p2, marriage_date, divorce_date
   - **Используется в:** Визуализация браков, группировка детей

4. **`UnionChild`** (строки 30-33)
   - **Миссия:** Связь союз→ребёнок
   - **Используется в:** Построение рёбер в графе

5. **`TreeData`** (строки 35-40)
   - **Миссия:** Полный набор данных для визуализации дерева
   - **Содержит:** persons[], parentChild[], unions[], unionChildren[]
   - **Используется в:** API response, props компонентов

6. **`TreeMode`** (строка 42)
   - **Миссия:** Режимы отображения дерева
   - **Значения:** 'ancestors' | 'descendants' | 'hourglass'
   - **Используется в:** API параметры, UI селектор

7. **`TreeRequest`** (строки 44-48)
   - **Миссия:** Параметры запроса дерева
   - **Поля:** proband_id (корневой человек), mode, depth
   - **Используется в:** API endpoint, форма запроса

8. **React Flow типы** (строки 57-81)
   - **`PersonNodeData`**, **`UnionNodeData`** - данные узлов
   - **`TreeNode`**, **`TreeEdge`** - узлы и рёбра для React Flow
   - **Используется в:** Компоненты визуализации (TreeCanvas, PersonCard, UnionNode)

---

#### 10:25 - Переписан API endpoint /api/tree

**Файл:** `src/app/api/tree/route.ts` (247 строк)

**Изменения:**

1. **Добавлена поддержка параметров** (строки 33-35):
   - `proband_id` - UUID корневого человека
   - `mode` - режим отображения (ancestors/descendants/hourglass)
   - `depth` - глубина обхода (1-10, по умолчанию 4)
   - **Используется в:** URL параметры для запроса дерева

2. **Функция `getAncestors`** (строки 149-167)
   - **Миссия:** Рекурсивный обход вверх по дереву через VIEW gt_v_parent_child
   - **Алгоритм:** Итеративно проходит от детей к родителям, уровень за уровнем
   - **Возвращает:** Set всех UUID предков (предотвращает дубликаты)
   - **Используется в:** Режим 'ancestors' и 'hourglass'

3. **Функция `getDescendants`** (строки 180-198)
   - **Миссия:** Рекурсивный обход вниз по дереву через VIEW gt_v_parent_child
   - **Алгоритм:** Итеративно проходит от родителей к детям, уровень за уровнем
   - **Возвращает:** Set всех UUID потомков
   - **Используется в:** Режим 'descendants' и 'hourglass'

4. **Функция `fetchTreeData`** (строки 213-246)
   - **Миссия:** Получение полных данных для визуализации
   - **Выполняет 4 параллельных запроса:**
     - `gt_v_person` - данные о людях (имена, даты, фото)
     - `gt_v_parent_child` - связи родитель→ребёнок
     - `gt_v_union` - виртуальные узлы браков
     - `gt_v_union_child` - связи союз→ребёнок
   - **Оптимизация:** Promise.all для параллельного выполнения
   - **Возвращает:** Объект TreeData типа {persons, parentChild, unions, unionChildren}

5. **Добавлен audit logging** (строки 39-46, 106-118, 125-133)
   - Логируются все запросы: успешные, ошибки валидации, исключения
   - Записывается: mode, depth, количество найденных людей и связей
   - **Используется в:** Мониторинг использования API, отладка

6. **Кэширование** (строка 122)
   - `Cache-Control: public, max-age=300` - кэш на 5 минут
   - **Миссия:** Уменьшение нагрузки на БД для повторных запросов

**Связи с другими компонентами:**
- Использует типы из `src/components/tree/types.ts`
- Вызывается из страницы `/tree/[id]` (будет создана)
- Зависит от VIEW из миграции `0011_tree_views.sql`

---

## Следующие задачи

### Текущая сессия:
- [x] Создать API endpoint `/api/tree` с рекурсивными запросами
- [ ] Создать компоненты визуализации (TreeCanvas, PersonCard, UnionNode)
- [ ] Создать функцию раскладки с ELK
- [ ] Создать страницу `/tree/[id]`

### Глобальные задачи (из TODO list):
- [ ] Разделение на админов и обычных пользователей
- [ ] Система подтверждения усопших родственников (3+ подтверждения)
- [ ] Улучшенный дашборд с формой данных о себе
- [ ] Адреса проживания (с годами)
- [ ] Места учёбы и работы
- [ ] Тестирование через Playwright
- [ ] Система приглашений по email

---

## Правила ведения лога

1. **Каждое изменение файла** должно быть записано
2. **Формат записи:**
   - Время
   - Файл и строки
   - Что изменено
   - Миссия/цель изменения
   - Где используется
3. **Комментарии в коде** обязательны для каждой функции
4. **Атомарные коммиты** в формате `tree: <описание>`

---

*Лог обновляется в реальном времени по мере работы над проектом*
