# Development Log - Gene Tree Project

**Проект**: Генеалогическое дерево (Genealogical Tree)  
**Дата начала лога**: 2025-11-10  
**Цель**: Детальное отслеживание всех изменений в проекте

---

## 2025-11-10

### Сессия 1: Визуализация Family Tree

#### 10:05 - Инициализация проекта визуализации дерева

**Установлены зависимости:**
- `@xyflow/react` - библиотека для интерактивных графов
- `elkjs` - алгоритм автоматической раскладки (Sugiyama layout для иерархий)
- `zustand` - state management для React

**Команда:**
```bash
npm install @xyflow/react elkjs zustand
```

**Миссия:** Подготовка инструментов для визуализации семейного дерева с поддержкой панорамирования, зума и автоматической раскладки узлов.

---

#### 10:10 - Создана SQL миграция для VIEW-адаптеров

**Файл:** `supabase/migrations/0011_tree_views.sql`

**Создано 5 VIEW:**

1. **`gt_v_person`** (строки 10-28)
   - **Миссия:** Нормализованное представление людей из таблицы `user_profiles`
   - **Что делает:** Объединяет first_name, middle_name, last_name в единое поле `name`
   - **Используется в:** API endpoint `/api/tree` для получения данных о людях

2. **`gt_v_parent_child`** (строки 36-41)
   - **Миссия:** Извлечение связей родитель→ребёнок из таблицы `relationships`
   - **Что делает:** Фильтрует только relationship_type='parent'
   - **Используется в:** Построение иерархии дерева, рекурсивные запросы

3. **`gt_v_union`** (строки 50-89)
   - **Миссия:** Создание виртуальных "союзов" (браки/партнёрства) между родителями
   - **Что делает:** 
     - Находит пары супругов (relationship_type='spouse')
     - Находит пары со-родителей (у которых есть общие дети)
     - Объединяет их в единый список союзов
   - **Формат ID:** `'U:' || person1_id || ':' || person2_id`
   - **Используется в:** Визуализация браков на дереве, группировка детей по парам родителей

4. **`gt_v_union_child`** (строки 97-128)
   - **Миссия:** Связь "союз→ребёнок" для правильной визуализации
   - **Что делает:**
     - Определяет, какие дети принадлежат каким союзам родителей
     - Обрабатывает случаи с двумя родителями и одним родителем (single parent)
   - **Используется в:** Построение рёбер от "союза" к детям в графе

5. **`gt_v_tree_stats`** (строки 134-139)
   - **Миссия:** Быстрая статистика по данным дерева
   - **Что делает:** Подсчитывает количество людей, связей, союзов
   - **Используется в:** Отладка, мониторинг данных

**Применение:** Миграция будет применена через Supabase CLI или Railway

---

#### 10:15 - Созданы TypeScript типы

**Файл:** `src/components/tree/types.ts`

**Основные типы:**

1. **`Person`** (строки 3-15)
   - **Миссия:** Описание человека в дереве
   - **Поля:** id, name, gender, birth_date, death_date, photo_url, is_alive
   - **Используется в:** Все компоненты визуализации, API responses

2. **`ParentChild`** (строки 17-20)
   - **Миссия:** Связь родитель→ребёнок
   - **Используется в:** Построение иерархии, рекурсивные запросы

3. **`Union`** (строки 22-28)
   - **Миссия:** Виртуальный узел "союз" (брак/партнёрство)
   - **Поля:** union_id, p1, p2, marriage_date, divorce_date
   - **Используется в:** Визуализация браков, группировка детей

4. **`UnionChild`** (строки 30-33)
   - **Миссия:** Связь союз→ребёнок
   - **Используется в:** Построение рёбер в графе

5. **`TreeData`** (строки 35-40)
   - **Миссия:** Полный набор данных для визуализации дерева
   - **Содержит:** persons[], parentChild[], unions[], unionChildren[]
   - **Используется в:** API response, props компонентов

6. **`TreeMode`** (строка 42)
   - **Миссия:** Режимы отображения дерева
   - **Значения:** 'ancestors' | 'descendants' | 'hourglass'
   - **Используется в:** API параметры, UI селектор

7. **`TreeRequest`** (строки 44-48)
   - **Миссия:** Параметры запроса дерева
   - **Поля:** proband_id (корневой человек), mode, depth
   - **Используется в:** API endpoint, форма запроса

8. **React Flow типы** (строки 57-81)
   - **`PersonNodeData`**, **`UnionNodeData`** - данные узлов
   - **`TreeNode`**, **`TreeEdge`** - узлы и рёбра для React Flow
   - **Используется в:** Компоненты визуализации (TreeCanvas, PersonCard, UnionNode)

---

#### 10:25 - Переписан API endpoint /api/tree

**Файл:** `src/app/api/tree/route.ts` (247 строк)

**Изменения:**

1. **Добавлена поддержка параметров** (строки 33-35):
   - `proband_id` - UUID корневого человека
   - `mode` - режим отображения (ancestors/descendants/hourglass)
   - `depth` - глубина обхода (1-10, по умолчанию 4)
   - **Используется в:** URL параметры для запроса дерева

2. **Функция `getAncestors`** (строки 149-167)
   - **Миссия:** Рекурсивный обход вверх по дереву через VIEW gt_v_parent_child
   - **Алгоритм:** Итеративно проходит от детей к родителям, уровень за уровнем
   - **Возвращает:** Set всех UUID предков (предотвращает дубликаты)
   - **Используется в:** Режим 'ancestors' и 'hourglass'

3. **Функция `getDescendants`** (строки 180-198)
   - **Миссия:** Рекурсивный обход вниз по дереву через VIEW gt_v_parent_child
   - **Алгоритм:** Итеративно проходит от родителей к детям, уровень за уровнем
   - **Возвращает:** Set всех UUID потомков
   - **Используется в:** Режим 'descendants' и 'hourglass'

4. **Функция `fetchTreeData`** (строки 213-246)
   - **Миссия:** Получение полных данных для визуализации
   - **Выполняет 4 параллельных запроса:**
     - `gt_v_person` - данные о людях (имена, даты, фото)
     - `gt_v_parent_child` - связи родитель→ребёнок
     - `gt_v_union` - виртуальные узлы браков
     - `gt_v_union_child` - связи союз→ребёнок
   - **Оптимизация:** Promise.all для параллельного выполнения
   - **Возвращает:** Объект TreeData типа {persons, parentChild, unions, unionChildren}

5. **Добавлен audit logging** (строки 39-46, 106-118, 125-133)
   - Логируются все запросы: успешные, ошибки валидации, исключения
   - Записывается: mode, depth, количество найденных людей и связей
   - **Используется в:** Мониторинг использования API, отладка

6. **Кэширование** (строка 122)
   - `Cache-Control: public, max-age=300` - кэш на 5 минут
   - **Миссия:** Уменьшение нагрузки на БД для повторных запросов

**Связи с другими компонентами:**
- Использует типы из `src/components/tree/types.ts`
- Вызывается из страницы `/tree/[id]` (будет создана)
- Зависит от VIEW из миграции `0011_tree_views.sql`

---

## Следующие задачи

#### 10:35 - Созданы функции построения графа и компоненты узлов

**Файл 1:** `src/components/tree/build-graph.ts` (224 строки)

**Функции:**

1. **`buildGraph`** (строки 44-120)
   - **Миссия:** Преобразование TreeData в формат React Flow
   - **Алгоритм:**
     1. Создаёт узлы person для всех людей
     2. Создаёт узлы union для браков
     3. Рёбра person→union (родители к браку)
     4. Рёбра union→child (брак к детям)
     5. Прямые рёбра parent→child для одиноких родителей
   - **Используется в:** TreeCanvas перед layout

2. **`validateGraph`** (строки 137-158)
   - **Миссия:** Проверка целостности графа
   - Проверяет что все source/target рёбер существуют в узлах
   - **Используется в:** Отладка, опционально перед рендерингом

3. **`filterGraphByDepth`** (строки 176-224)
   - **Миссия:** Фильтрация по глубине от proband
   - **Алгоритм:** BFS (поиск в ширину) для определения расстояния
   - Позволяет динамически менять глубину без повторного запроса API
   - **Используется в:** TreeCanvas при изменении depth slider

**Файл 2:** `src/components/tree/PersonCard.tsx` (162 строки)

**Компонент:** PersonCard - карточка человека в дереве

**Отображает:**
- Аватар или инициалы (48×48px круг)
- Имя (полное или сокращённое)
- Даты жизни: (1901–1988) или (род. 1956)
- Цветная рамка: голубая (male), розовая (female), серая (other)
- Индикатор "усопший" если is_alive=false

**Размер:** 180×80px
**Стиль:** Тень, скругление, hover увеличение (scale-105)

**Функции:**
- `formatLifespan()` - форматирование дат жизни
- `getBorderColor()` - цвет рамки по полу
- `getInitials()` - инициалы для placeholder

**Handle точки:**
- Top: входящие рёбра (от родителей/союзов)
- Bottom: исходящие рёбра (к детям/союзам)

**Файл 3:** `src/components/tree/UnionNode.tsx` (145 строк)

**Компонент:** UnionNode - узел брака/партнёрства

**Отображает:**
- Маленький круг 20×20px
- Цвет: зелёный (активный брак), оранжевый (развод)
- Tooltip при hover: даты брака/развода

**Размер:** 20×20px (минималистичный)
**Стиль:** Hover увеличение (scale-125)

**Функции:**
- `formatMarriageDate()` - год брака
- `getNodeColor()` - цвет по статусу
- `getTooltipText()` - текст для tooltip

**Handle точки:**
- Top: 2 входящих рёбра (от двух родителей)
- Bottom: исходящие рёбра (к детям)

**Связи:**
- Используются в TreeCanvas как nodeTypes
- Зависят от @xyflow/react (Handle, Position)
- Получают данные из buildGraph

---

#### 10:37 - Созданы функции раскладки (layout.ts)

**Файл:** `src/components/tree/layout.ts` (259 строк)

**Функции:**

1. **`applyLayout`** (строки 74-145)
   - **Миссия:** Применение ELK Sugiyama layout к графу
   - **Алгоритм:**
     1. Конвертирует React Flow nodes → ELK формат
     2. Вызывает elk.layout() асинхронно (100-500ms)
     3. Конвертирует обратно: ELK → React Flow с координатами
   - **Параметры раскладки:**
     - Algorithm: 'layered' (Sugiyama для иерархий)
     - Direction: DOWN (сверху вниз)
     - Node spacing: 30px (расстояние между узлами)
     - Layer spacing: 80px (расстояние между поколениями)
     - Edge routing: ORTHOGONAL (прямые углы)
   - **Используется в:** TreeCanvas при первом рендере и изменении data

2. **`applyLayoutWithAnimation`** (строки 163-182)
   - **Миссия:** Плавная анимация при изменении графа
   - Сохраняет старые позиции узлов
   - React Flow автоматически анимирует переход
   - **Используется в:** Будущая оптимизация для динамического обновления

3. **`calculateGraphBounds`** (строки 197-218)
   - **Миссия:** Вычисление границ графа (bounding box)
   - Находит min/max координаты всех узлов
   - **Используется в:** Экспорт SVG/PNG, определение области печати

4. **`centerGraph`** (строки 232-259)
   - **Миссия:** Центрирование графа вокруг (0, 0)
   - Смещает все узлы так, чтобы центр графа был в начале координат
   - **Используется в:** fitView для правильного позиционирования

**Зависимости:**
- `elkjs` - основной движок раскладки
- `@xyflow/react` - типы Node, Edge
- Используется в TreeCanvas

**Конфигурация ELK:**
```typescript
layered.nodePlacement.strategy = 'NETWORK_SIMPLEX'
layered.crossingMinimization.strategy = 'LAYER_SWEEP'
edgeRouting = 'ORTHOGONAL'
```

---

#### 10:45 - Создан главный компонент TreeCanvas

**Файл:** `src/components/tree/TreeCanvas.tsx` (246 строк)

**Компонент:** TreeCanvas - главный canvas визуализации дерева

**Миссия:** Интеграция всех компонентов в единый интерактивный canvas

**Интегрирует:**
- React Flow (canvas, панорамирование, зум)
- PersonCard и UnionNode (кастомные типы узлов)
- buildGraph (преобразование TreeData → граф)
- applyLayout (ELK раскладка)

**Возможности:**
- Панорамирование: drag canvas мышкой
- Зум: колесо мыши или кнопки Controls
- MiniMap: миникарта навигации (слева внизу)
- Controls: кнопки zoom/fit (справа внизу)
- Background: сетка точек
- Loading overlay: спиннер во время раскладки

**Props:**
- `data: TreeData` - данные из API
- `onNodeClick?: (nodeId) => void` - callback при клике
- `className?: string` - доп. CSS классы

**Жизненный цикл:**
1. Получает data через props
2. Преобразует в граф (buildGraph)
3. Применяет раскладку асинхронно (applyLayout)
4. Обновляет state узлов/рёбер
5. React Flow отрисовывает с автоматической анимацией

**State:**
- `nodes, edges` - React Flow hooks (useNodesState, useEdgesState)
- `isLayouting` - флаг загрузки во время раскладки

**Настройки React Flow:**
- `fitView` - автоматически подгоняет под размер экрана
- `minZoom: 0.1, maxZoom: 2` - ограничения зума
- `nodesDraggable: false` - узлы не перетаскиваются (раскладка фиксирована)
- `nodesConnectable: false` - нельзя создавать новые связи
- `defaultEdgeOptions: { type: 'smoothstep', stroke: '#94a3b8' }`

**MiniMap цвета:**
- Зелёный: узлы union (браки)
- Голубой: male person
- Розовый: female person
- Серый: other/unknown

**Используется в:** Страница `/tree/[id]`

---

#### 10:50 - Создана страница /tree/[id]

**Файл:** `src/app/tree/[id]/page.tsx` (324 строки)

**Компонент:** TreePage - полноценная страница визуализации дерева

**Миссия:** UI для работы с семейным деревом конкретного человека

**Функциональность:**

1. **Загрузка данных через API** (строки 64-87)
   - Запрос: `GET /api/tree?proband_id={id}&mode={mode}&depth={depth}`
   - Обработка loading/error состояний
   - Автоматическая перезагрузка при изменении mode/depth

2. **Боковая панель с контролами** (строки 142-284)
   - **Mode Selector:** 3 кнопки для режимов
     - Предки: родители, бабушки, прабабушки...
     - Потомки: дети, внуки, правнуки...
     - Песочные часы: и предки, и потомки
   - **Depth Slider:** диапазон 1-10 поколений
   - **Поиск:** input для поиска людей (TODO: реализовать)
   - **Статистика:** кол-во людей, браков, связей
   - **Экспорт:** кнопки SVG/PNG/Print (TODO: реализовать)

3. **Canvas область** (строки 286-321)
   - TreeCanvas с полными данными
   - Loading состояние: спиннер
   - Error состояние: сообщение + кнопка retry

**Layout:**
- Full screen (h-screen)
- Flex row
- Sidebar: фиксированная ширина 320px (w-80)
- Canvas: flex-1 (всё оставшееся пространство)

**Callbacks:**
- `handleNodeClick` - переход на /profile/{id} при клике на человека
- `handleExportSVG/PNG/Print` - TODO (пока alert)

**TODO в будущем:**
- Реализовать экспорт SVG через React Flow API
- Реализовать экспорт PNG через html2canvas
- Создать print CSS для A4 формата
- Реализовать поиск людей в дереве (фильтрация/подсветка)

**Связи:**
- Использует TreeCanvas
- Вызывает API /api/tree
- Навигирует на /profile/{id}

---

#### 10:55 - Commit и push на GitHub

**Commit:** `tree: add layout functions, TreeCanvas component and /tree/[id] page`

**Файлы в коммите:**
- `src/components/tree/layout.ts` - NEW
- `src/components/tree/TreeCanvas.tsx` - NEW
- `src/app/tree/[id]/page.tsx` - NEW
- Другие файлы (settings page, health endpoint, kinship mapping) - из предыдущих изменений

**Push:** успешно отправлено на `git@github.com:filippmiller/gene-tree.git`

---

### Текущая сессия:
- [x] Создать API endpoint `/api/tree` с рекурсивными запросами
- [x] Создать компоненты визуализации (build-graph, PersonCard, UnionNode)
- [x] Создать функцию раскладки с ELK
- [x] Создать главный компонент TreeCanvas
- [x] Создать страницу `/tree/[id]` с UI контролами
- [ ] **СЛЕДУЮЩЕЕ: Применить SQL миграцию 0011_tree_views.sql** (пользователь применит вручную)
- [ ] Протестировать систему end-to-end

### Глобальные задачи (из TODO list):
- [ ] Разделение на админов и обычных пользователей
- [ ] Система подтверждения усопших родственников (3+ подтверждения)
- [ ] Улучшенный дашборд с формой данных о себе
- [ ] Адреса проживания (с годами)
- [ ] Места учёбы и работы
- [ ] Тестирование через Playwright
- [ ] Система приглашений по email

---

## Правила ведения лога

1. **Каждое изменение файла** должно быть записано
2. **Формат записи:**
   - Время
   - Файл и строки
   - Что изменено
   - Миссия/цель изменения
   - Где используется
3. **Комментарии в коде** обязательны для каждой функции
4. **Атомарные коммиты** в формате `tree: <описание>`

---

*Лог обновляется в реальном времени по мере работы над проектом*
