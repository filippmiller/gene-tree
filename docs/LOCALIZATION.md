# –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è / Localization System

## –û–±–∑–æ—Ä / Overview

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —è–∑—ã–∫–∞: **—Ä—É—Å—Å–∫–∏–π (ru)** –∏ **–∞–Ω–≥–ª–∏–π—Å–∫–∏–π (en)**.

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤—ã–±–æ—Ä.

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ / Language Detection Priority

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

1. **URL –ø–∞—Ä–∞–º–µ—Ç—Ä** - `/ru/dashboard` –∏–ª–∏ `/en/dashboard`
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - `user_profiles.preferred_locale` (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
3. **Cookie** - `NEXT_LOCALE`
4. **Accept-Language –∑–∞–≥–æ–ª–æ–≤–æ–∫** - –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
5. **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é** - `ru` (—Ä—É—Å—Å–∫–∏–π)

---

## üìä –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö / Database Schema

### –¢–∞–±–ª–∏—Ü–∞ `user_profiles`

```sql
ALTER TABLE user_profiles
ADD COLUMN preferred_locale TEXT DEFAULT 'ru' CHECK (preferred_locale IN ('ru', 'en'));
```

- **–ö–æ–ª–æ–Ω–∫–∞:** `preferred_locale`
- **–¢–∏–ø:** `TEXT`
- **–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:** `'ru'` –∏–ª–∏ `'en'`
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** `'ru'`
- **–ò–Ω–¥–µ–∫—Å:** `idx_user_profiles_preferred_locale`

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä `create_user_profile()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–∑ `Accept-Language` –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `preferred_locale`.

---

## üîß API Endpoints

### GET `/api/user/locale`

–ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Response:**
```json
{
  "locale": "ru"
}
```

### POST `/api/user/locale`

–û–±–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Request:**
```json
{
  "locale": "en"
}
```

**Response:**
```json
{
  "success": true,
  "locale": "en"
}
```

---

## üé® Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### LanguageSwitcher

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å **–¥—Ä—É–≥–∏–º** —è–∑—ã–∫–æ–º (–µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π RU, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç EN)
- –ü—Ä–∏ –∫–ª–∏–∫–µ:
  1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –≤ –ë–î —á–µ—Ä–µ–∑ API
  2. –û–±–Ω–æ–≤–ª—è–µ—Ç cookie
  3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ URL —Å –Ω–æ–≤—ã–º –ª–æ–∫–∞–ª–µ–º

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```tsx
import LanguageSwitcher from '@/components/LanguageSwitcher';

<LanguageSwitcher />
```

---

## üåê Routing –∏ Middleware

### –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

1. **`src/i18n/routing.ts`** - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–∫–∞–ª–µ–π
2. **`src/proxy.ts`** - Next.js middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ URL
3. **`src/i18n/request.ts`** - server-side –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª–∏

### URL —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- **–° –ª–æ–∫–∞–ª—å—é:** `/ru/dashboard`, `/en/people`
- **–ë–µ–∑ –ª–æ–∫–∞–ª–∏:** `/` (—Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/ru` –∏–ª–∏ `/en` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

### –û–ø—Ü–∏—è `localePrefix: 'as-needed'`

–î–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ (ru) –ø—Ä–µ—Ñ–∏–∫—Å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω:
- `/dashboard` = `/ru/dashboard`
- `/en/dashboard` = –∞–Ω–≥–ª–∏–π—Å–∫–∞—è –≤–µ—Ä—Å–∏—è

---

## üìù –ü–µ—Ä–µ–≤–æ–¥—ã / Translations

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/messages/
  ‚îú‚îÄ‚îÄ ru/
  ‚îÇ   ‚îî‚îÄ‚îÄ common.json
  ‚îî‚îÄ‚îÄ en/
      ‚îî‚îÄ‚îÄ common.json
```

### –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤

```json
{
  "nav": {
    "dashboard": "–î–∞—à–±–æ—Ä–¥",
    "people": "–õ—é–¥–∏",
    "profile": "–ü—Ä–æ—Ñ–∏–ª—å"
  },
  "common": {
    "save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
    "cancel": "–û—Ç–º–µ–Ω–∞"
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```tsx
import { useTranslations } from 'next-intl';

export default function MyComponent() {
  const t = useTranslations('nav');
  
  return <h1>{t('dashboard')}</h1>; // "–î–∞—à–±–æ—Ä–¥" –∏–ª–∏ "Dashboard"
}
```

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç** - —Å–∏—Å—Ç–µ–º–∞ —á–∏—Ç–∞–µ—Ç `Accept-Language` –∑–∞–≥–æ–ª–æ–≤–æ–∫
2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** - Supabase —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `auth.users`
3. **–¢—Ä–∏–≥–≥–µ—Ä** - `create_user_profile()` –ø–∞—Ä—Å–∏—Ç —è–∑—ã–∫ –±—Ä–∞—É–∑–µ—Ä–∞
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - `preferred_locale` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. **–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Å–≤–æ–µ–º —è–∑—ã–∫–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Playwright —Ç–µ—Å—Ç—ã

–§–∞–π–ª: `tests/locale-and-layout.spec.ts`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- URL –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è
- –ü–µ—Ä–µ–≤–æ–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

**–ó–∞–ø—É—Å–∫:**
```bash
npx playwright test tests/locale-and-layout.spec.ts
```

---

## üõ† –£—Ç–∏–ª–∏—Ç—ã

### `src/lib/locale-detection.ts`

–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞:

- `detectLocaleFromHeader(acceptLanguage)` - –ø–∞—Ä—Å–∏—Ç Accept-Language
- `detectLocaleFromNavigator()` - client-side —á–µ—Ä–µ–∑ navigator.language
- `detectUserLocale(options)` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

---

## üìã –ú–∏–≥—Ä–∞—Ü–∏–∏

### 0025_add_preferred_locale.sql

- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `preferred_locale`
- –°–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä `create_user_profile()` –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
supabase db push
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞ / Debugging

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
SELECT id, first_name, last_name, preferred_locale 
FROM user_profiles 
WHERE id = '<user-id>';
```

### –í—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫

```sql
UPDATE user_profiles 
SET preferred_locale = 'en' 
WHERE id = '<user-id>';
```

### Console logs

–í –±—Ä–∞—É–∑–µ—Ä–µ:
```javascript
// –¢–µ–∫—É—â–∏–π –ª–æ–∫–∞–ª—å
console.log(document.cookie.match(/NEXT_LOCALE=([^;]+)/)?.[1]);

// –Ø–∑—ã–∫ –±—Ä–∞—É–∑–µ—Ä–∞
console.log(navigator.language);
```

---

## üöÄ Best Practices

1. ‚úÖ **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `useTranslations()`** –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
2. ‚úÖ **–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã –≤ –æ–±–∞ —Ñ–∞–π–ª–∞** (ru –∏ en) –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –æ–±–æ–∏—Ö —è–∑—ã–∫–∞—Ö** –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
4. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏** (`nav.dashboard` –ª—É—á—à–µ —á–µ–º `text1`)
5. ‚ö†Ô∏è **–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –¥–∞—Ç—ã –∏ —á–∏—Å–ª–∞** - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π—Ç–µ —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª–∏

---

## üìö –°—Å—ã–ª–∫–∏

- [next-intl –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://next-intl-docs.vercel.app/)
- [Next.js i18n routing](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
- [Accept-Language header MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language)
