# Gene-Tree Project Handoff
**Date**: November 14, 2025  
**Project**: Gene-Tree - Family Tree Genealogy Application  
**Status**: Active Development

---

## üéØ Project Overview

**Gene-Tree** is a full-stack genealogy application that allows users to build and visualize their family trees, manage relationships, and track family history with education, residence, and biographical data.

### Key Features
- üë• Family tree visualization with interactive canvas
- üîê Authentication with Supabase (magic link & password)
- üåê Bilingual support (Russian/English) with next-intl
- üìö Education history tracking
- üè† Residence history tracking
- üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Relationship management (parents, children, spouses)
- üì∏ Avatar uploads with photo moderation
- üå≥ Interactive family tree with D3.js-based visualization

---

## üõ†Ô∏è Technology Stack

### Frontend
- **Framework**: Next.js 15.0.3 (App Router)
- **Language**: TypeScript 5.6.3
- **Styling**: Tailwind CSS 3.4.14
- **UI Components**: shadcn/ui + Radix UI
- **Icons**: Lucide React
- **Visualization**: D3.js (custom tree layout)
- **Internationalization**: next-intl 3.23.5

### Backend & Database
- **Database**: PostgreSQL via Supabase
- **Auth**: Supabase Auth (magic links + password)
- **Storage**: Supabase Storage (avatars, photos)
- **Real-time**: Supabase Realtime (optional)
- **ORM**: Supabase JS Client 2.46.1

### Deployment & DevOps
- **Hosting**: Railway (production)
- **CI/CD**: Git push ‚Üí Railway auto-deploy
- **Environment**: Node.js 20.x
- **Package Manager**: npm

### Development Tools
- **Testing**: Playwright 1.48.2
- **Linting**: ESLint 9.x
- **Type Checking**: TypeScript strict mode
- **Git**: GitHub repository

---

## üîë Credentials & Access

### Production URLs
- **Application**: https://gene-tree-production.up.railway.app
- **Repository**: https://github.com/filippmiller/gene-tree

### Supabase
- **Project URL**: https://mbntpsfllwhlnzuzspvp.supabase.co
- **Project ID**: `mbntpsfllwhlnzuzspvp`
- **Dashboard**: https://supabase.com/dashboard/project/mbntpsfllwhlnzuzspvp

**Environment Variables Required:**
```env
NEXT_PUBLIC_SUPABASE_URL=https://mbntpsfllwhlnzuzspvp.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[see .env.local]
SUPABASE_SERVICE_ROLE_KEY=[see .env.local]
```

**To Access:**
1. Login to https://supabase.com
2. Use your account credentials
3. Select project: `gene-tree` (mbntpsfllwhlnzuzspvp)

### Railway
- **Project**: gene-tree-production
- **Dashboard**: https://railway.app

**To Access:**
1. Login to https://railway.app
2. Use your GitHub account (OAuth)
3. Select project: gene-tree-production

**Environment Variables Set in Railway:**
- All Supabase keys
- `NODE_TLS_REJECT_UNAUTHORIZED=0` (for dev/test only)
- Auto-synced from GitHub on push to `main`

### GitHub Repository
- **URL**: https://github.com/filippmiller/gene-tree
- **Main Branch**: `main`
- **Access**: filippmiller account

---

## üöÄ Local Development Setup

### Prerequisites
- Node.js 20.x or later
- npm (comes with Node.js)
- Git
- Code editor (VS Code recommended)

### Step 1: Clone Repository
```bash
git clone https://github.com/filippmiller/gene-tree.git
cd gene-tree
```

### Step 2: Install Dependencies
```bash
npm install
```

### Step 3: Environment Variables
Create `.env.local` file in root directory:

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://mbntpsfllwhlnzuzspvp.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ibnRwc2ZsbHdobG56dXpzcHZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA4Mjg5MTIsImV4cCI6MjA0NjQwNDkxMn0.VJ0YFBvJT4pf6FZ9TlJB_JR3UkKj9Qb7TnR7GkCJR_o
SUPABASE_SERVICE_ROLE_KEY=[get from Supabase dashboard ‚Üí Settings ‚Üí API]

# Development Only (disable TLS checks)
NODE_TLS_REJECT_UNAUTHORIZED=0
```

**‚ö†Ô∏è IMPORTANT**: Never commit `.env.local` to git! It's in `.gitignore`.

### Step 4: Run Development Server
```bash
npm run dev
```

Open http://localhost:3000

### Step 5: Verify Setup
1. Navigate to http://localhost:3000/ru/sign-in
2. Test login with your account
3. Check console for errors

---

## üìÅ Project Structure

```
gene-tree/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [locale]/                 # Internationalized routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/               # Auth pages (sign-in, sign-up)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (protected)/          # Protected routes (require auth)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/              # Dashboard
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ family-profile/   # Family profile editor
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ my-profile/       # User profile
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ people/           # People list
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile/[id]/     # View any profile
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relations/        # Relationships
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tree/[id]/        # Family tree visualization
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx            # Locale layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                      # API routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # Auth endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relationships-temp/   # Relationship data
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree-data/            # Tree visualization data
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user/                 # User endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx                # Root layout
‚îÇ   ‚îú‚îÄ‚îÄ components/                   # React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                     # Auth components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile/                  # Profile forms & sections
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EducationForm.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EducationSection.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResidenceForm.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResidenceSection.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProfileForm.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relationships/            # Relationship components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree/                     # Tree visualization
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # shadcn/ui components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LanguageSwitcher.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Nav.tsx
‚îÇ   ‚îú‚îÄ‚îÄ lib/                          # Utilities & helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase/                 # Supabase clients
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ browser.ts            # Client-side
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server-ssr.ts         # Server-side (SSR)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server-admin.ts       # Admin client
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/                    # TypeScript types
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts           # Generated DB types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                    # Utility functions
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ date-formatter.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ education-icons.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts                 # Production-safe logger
‚îÇ   ‚îú‚îÄ‚îÄ messages/                     # i18n translations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ en/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ru/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ common.json
‚îÇ   ‚îî‚îÄ‚îÄ i18n/                         # Internationalization config
‚îÇ       ‚îú‚îÄ‚îÄ routing.ts
‚îÇ       ‚îî‚îÄ‚îÄ request.ts
‚îú‚îÄ‚îÄ migrations/                       # Database migrations
‚îÇ   ‚îî‚îÄ‚îÄ 001_education_residence_schema.sql
‚îú‚îÄ‚îÄ tests/                            # Playwright tests
‚îÇ   ‚îî‚îÄ‚îÄ language-switcher.spec.ts
‚îú‚îÄ‚îÄ docs/                             # Documentation
‚îú‚îÄ‚îÄ public/                           # Static assets
‚îú‚îÄ‚îÄ .env.local                        # Environment variables (local)
‚îú‚îÄ‚îÄ next.config.ts                    # Next.js configuration
‚îú‚îÄ‚îÄ tailwind.config.ts                # Tailwind CSS config
‚îú‚îÄ‚îÄ tsconfig.json                     # TypeScript config
‚îî‚îÄ‚îÄ package.json                      # Dependencies
```

---

## üóÑÔ∏è Database Schema

### Core Tables

#### `user_profiles`
User profile data linked to Supabase Auth
- `id` (uuid, PK) - matches auth.users.id
- `first_name`, `last_name`, `middle_name`
- `birth_date`, `birth_place`
- `avatar_url`
- `preferred_locale` ('ru' | 'en')
- `created_at`, `updated_at`

#### `relationships`
Family relationships between users
- `id` (uuid, PK)
- `from_person_id` (uuid, FK ‚Üí user_profiles)
- `to_person_id` (uuid, FK ‚Üí user_profiles)
- `relationship_type` (enum: 'parent', 'child', 'spouse', 'sibling')
- `created_at`

#### `pending_relatives`
Relatives not yet registered
- `id` (uuid, PK)
- `added_by_user_id` (uuid, FK ‚Üí user_profiles)
- `first_name`, `last_name`, `middle_name`
- `relationship_to_adder`
- `invitation_status` (enum: 'pending', 'accepted', 'declined')

#### `person_education`
Education history entries
- `id` (uuid, PK)
- `person_id` (uuid, FK ‚Üí user_profiles)
- `education_type` (enum: 'school', 'university', 'course', 'other')
- `institution_name`
- `field_of_study`, `degree`
- `start_date`, `end_date` (with precision: day/month/year/unknown)
- `is_current` (boolean)
- `certainty` (enum: 'certain', 'approximate', 'unknown')
- `visibility` (enum: 'public', 'family', 'private')

#### `person_residence`
Residence history entries
- `id` (uuid, PK)
- `person_id` (uuid, FK ‚Üí user_profiles)
- `place_text` (display name)
- `country`, `region`, `city`, `district`, `street`
- `start_date`, `end_date` (with precision)
- `is_current` (boolean)
- `certainty`, `visibility`

### Reference Tables
- `institution_ref` - Schools/universities catalog
- `place_ref` - Cities/places catalog

### Row Level Security (RLS)
All tables have RLS policies enforcing:
- Users can read public data
- Users can read family-level data if related
- Users can only modify their own data
- Admins have elevated permissions

---

## üîÑ Database Type Generation

After schema changes, regenerate TypeScript types:

```bash
npx supabase gen types typescript --project-id mbntpsfllwhlnzuzspvp > src/lib/types/supabase.ts
```

This pulls the schema from the remote Supabase project and generates TypeScript interfaces.

---

## üåê Internationalization (i18n)

### Supported Languages
- **Russian (ru)** - default
- **English (en)**

### Configuration
- `src/i18n/routing.ts` - routing config
- `localePrefix: 'always'` - URLs always include locale (`/ru/`, `/en/`)
- Middleware in `src/proxy.ts` handles locale detection

### Translation Files
- `src/messages/ru/common.json`
- `src/messages/en/common.json`

### Usage in Components
```tsx
import { useTranslations } from 'next-intl';

export default function MyComponent() {
  const t = useTranslations('nav');
  return <h1>{t('dashboard')}</h1>;
}
```

### Adding New Translations
1. Add key to both `ru/common.json` and `en/common.json`
2. Use `t('yourKey')` in components
3. No restart needed in dev mode

---

## üé® Styling & UI

### Tailwind CSS
- Configuration: `tailwind.config.ts`
- Custom colors, shadows, animations defined
- Responsive breakpoints: sm, md, lg, xl, 2xl

### shadcn/ui Components
Located in `src/components/ui/`
- Button, Input, Label, Card, etc.
- Customizable via Tailwind classes

### Adding New UI Components
```bash
npx shadcn@latest add [component-name]
```

---

## üß™ Testing

### Playwright E2E Tests
```bash
# Run tests (headless)
npm run test:e2e

# Run tests (headed - visible browser)
npx playwright test --headed

# Run specific test
npx playwright test tests/language-switcher.spec.ts

# Show report
npx playwright show-report
```

### Test Files
- `tests/language-switcher.spec.ts` - Language switching test

---

## üì¶ Build & Deploy

### Local Build
```bash
# Type check
npm run typecheck

# Lint
npm run lint

# Build
npm run build

# Start production server
npm start
```

### Production Deploy (Railway)
**Automatic on Git Push:**
1. Commit changes: `git commit -m "your message"`
2. Push to main: `git push origin main`
3. Railway automatically detects push and deploys
4. Monitor progress: https://railway.app

**Build Configuration in Railway:**
- Build Command: `npm run build`
- Start Command: `npm start`
- Auto-restart on deploy

---

## üîß Common Development Tasks

### Running Database Migrations
1. Write SQL in `migrations/` folder
2. Run via Supabase Dashboard ‚Üí SQL Editor
3. Or use Supabase CLI (if installed)

### Adding New Routes
1. Create folder/file in `src/app/[locale]/`
2. Use `(protected)` for auth-required routes
3. Add navigation link in `src/components/Nav.tsx`
4. Add translations to `messages/*/common.json`

### Adding New Components
1. Create in `src/components/`
2. Follow naming convention: PascalCase.tsx
3. Add JSDoc comments explaining purpose
4. Keep components small and focused

### Debugging
- **Production logs**: Check Railway dashboard
- **Local logs**: Check terminal running `npm run dev`
- **Client logs**: Browser DevTools console
- **Logger utility**: Use `import { logger } from '@/lib/logger'`

---

## üêõ Known Issues & Workarounds

### Issue: Language Switcher
- **Problem**: `useLocale()` doesn't update after client-side navigation
- **Solution**: Using `window.location.href` for full page reload + `localePrefix: 'always'`

### Issue: Session Handling
- **Problem**: Auth state mismatch between server/client
- **Solution**: Using SSR auth + AuthSessionGuard component

### Issue: Console Spam in Production
- **Solution**: Logger utility that only logs in development

---

## üìö Key Documentation Files

- `HANDOFF-NOV-8.md` - Previous handoff (November 8)
- `docs/LOCALIZATION.md` - Detailed i18n documentation
- `docs/arch/overview.md` - Architecture overview
- `docs/ops/session-state-2025-11-08.md` - Session handling docs
- `MIGRATION_004_REPORT.md` - Migration history

---

## üîê Security Considerations

### Environment Variables
- **NEVER** commit `.env.local` to git
- Rotate keys if accidentally exposed
- Use different keys for dev/staging/prod

### Row Level Security (RLS)
- All tables have RLS enabled
- Test policies thoroughly before production
- Use service role key only in trusted server contexts

### Authentication
- Magic links expire after 1 hour
- Passwords hashed by Supabase Auth
- Session cookies are httpOnly and secure

---

## üìû Support & Resources

### Supabase Documentation
- https://supabase.com/docs
- https://supabase.com/docs/guides/auth

### Next.js Documentation
- https://nextjs.org/docs
- https://nextjs.org/docs/app

### next-intl Documentation
- https://next-intl-docs.vercel.app

### Railway Documentation
- https://docs.railway.app

---

## ‚úÖ Next Steps & TODO

### Immediate
- [ ] Test language switcher in production
- [ ] Verify education/residence forms work correctly
- [ ] Test on mobile devices

### Short Term
- [ ] Implement edit/delete for education entries
- [ ] Implement edit/delete for residence entries
- [ ] Build timeline view (chronological display)
- [ ] Add autocomplete for institutions (schools/universities)
- [ ] Add autocomplete for places (cities)

### Long Term
- [ ] Implement "Career" section (employment history)
- [ ] Implement "About Me" section (bio, interests)
- [ ] Add photo sharing between family members
- [ ] Build invitation flow for pending relatives
- [ ] Add search functionality
- [ ] Export family tree to PDF/image

---

## üÜò Emergency Contacts

### If Site is Down
1. Check Railway dashboard for build/deploy status
2. Check Supabase dashboard for database status
3. Check GitHub Actions for failed workflows
4. Review Railway logs for errors

### If Database Issues
1. Login to Supabase dashboard
2. Go to Database ‚Üí Replication ‚Üí check health
3. Review RLS policies if permission errors
4. Check API logs in Supabase

### If Auth Issues
1. Check Supabase Auth logs
2. Verify environment variables are set
3. Check RLS policies on user_profiles table
4. Test with fresh incognito window

---

## üìù Commit Message Convention

Follow this format:
```
<type>: <subject>

<body (optional)>
```

**Types:**
- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation changes
- `style:` - Code style changes (formatting)
- `refactor:` - Code refactoring
- `test:` - Adding tests
- `chore:` - Maintenance tasks

**Examples:**
```
feat: add residence history form

- Create ResidenceForm component
- Add date precision selection
- Integrate with person_residence table
```

---

## üéì Learning Resources

If you're new to the stack:
1. **Next.js 15 App Router**: https://nextjs.org/docs/app/building-your-application/routing
2. **Supabase Auth**: https://supabase.com/docs/guides/auth/quickstarts/nextjs
3. **TypeScript**: https://www.typescriptlang.org/docs/
4. **Tailwind CSS**: https://tailwindcss.com/docs

---

**Last Updated**: November 14, 2025  
**Prepared By**: AI Assistant (Warp)  
**For**: filippmiller

---

## Quick Reference Commands

```bash
# Install dependencies
npm install

# Start dev server
npm run dev

# Type check
npm run typecheck

# Lint code
npm run lint

# Run full check
npm run check

# Build for production
npm run build

# Start production server
npm start

# Run tests
npm run test:e2e

# Regenerate DB types
npx supabase gen types typescript --project-id mbntpsfllwhlnzuzspvp > src/lib/types/supabase.ts

# Add UI component
npx shadcn@latest add [component]

# Git workflow
git add .
git commit -m "your message"
git push origin main
```
